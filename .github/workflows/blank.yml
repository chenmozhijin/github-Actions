# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build1:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: 建立工作文件夹
        run:  |
          cd $GITHUB_WORKSPACE
          mkdir -p download
          cd download
          export DOWNLOAD_ROOT_PATH="$(pwd)"
          echo "DOWNLOAD_ROOT_PATH=$DOWNLOAD_ROOT_PATH" >> $GITHUB_ENV
          mkdir -p lede Lienol immortalwrt wongsyrone passwall turboacc other
          cd $GITHUB_WORKSPACE
          mkdir -p cmzj_package
          cd cmzj_package
          export CMZJ_PACKAGE_ROOT_PATH="$(pwd)"
          echo "CMZJ_PACKAGE_ROOT_PATH=$CMZJ_PACKAGE_ROOT_PATH" >> $GITHUB_ENV
          mkdir -p turboacc
          cd $GITHUB_WORKSPACE
          mkdir -p cmzj_patch
          cd cmzj_patch
          export CMZJ_PATCH_ROOT_PATH="$(pwd)"
          echo "CMZJ_PATCH_ROOT_PATH=$CMZJ_PATCH_ROOT_PATH" >> $GITHUB_ENV
          mkdir -p $CMZJ_PATCH_ROOT_PATH/firewall4/patches/ $CMZJ_PATCH_ROOT_PATH/libnftnl/patches/ $CMZJ_PATCH_ROOT_PATH/nftables/patches/ $CMZJ_PATCH_ROOT_PATH/hack-5.10 $CMZJ_PATCH_ROOT_PATH/hack-5.15 $CMZJ_PATCH_ROOT_PATH/hack-6.1 $CMZJ_PATCH_ROOT_PATH/dnsmasq $CMZJ_PATCH_ROOT_PATH/libubox $CMZJ_PATCH_ROOT_PATH/netdata
          cat $GITHUB_ENV >> build1_ENV
      - name: 准备上传
        run:  |
          cd $GITHUB_WORKSPACE
          sudo tar cvpzf /build1_WORKSPACE.tgz *
          ls


      - name: 上传 build1_WORKSPACE
        uses: actions/upload-artifact@v3
        with:
          name: build1_WORKSPACE
          path: /build1_WORKSPACE.tgz

  build2:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    needs:  build1
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
          
      - name: 下载build1_WORKSPACE
        uses: actions/download-artifact@v3
        with:
          name: build1_WORKSPACE
          
      - name: 解压
        run:  |
          sudo mv $GITHUB_WORKSPACE/build1_WORKSPACE.tgz /build1_WORKSPACE.tgz 
          tar xvpfz /build1_WORKSPACE.tgz  -C $GITHUB_WORKSPACE
          sudo rm -rf /build1_WORKSPACE.tgz
          cat build1_ENV
          cat build1_ENV >> $GITHUB_ENV
          
      - name: Run a one-line script
        run: cat $GITHUB_ENV && ls
          
          
